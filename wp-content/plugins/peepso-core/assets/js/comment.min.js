!function(e,t){function o(){this.init()}var a,m;t.comment=(a=e,(m=t).modules,m.npm.objectAssign(o.prototype,{init:function(){this.ajax={},a(a.proxy(function(){var e=(window.location.hash||"").match(/[#&]comment(?:\.|=)(\d+)\.(\d+)(?:\.(\d+)(?:\.(\d+))?)?/);e&&e[2]&&this.whenLoaded(e[1]).done(a.proxy(function(){this.reveal(e[1],e[2],e[3],e[4])},this))},this)),m.observer.addAction("post_loaded",function(e){var t=a(e),e=t.find("textarea[name=comment]");e.ps_autosize(),e.each(function(){var t=this;m.elements.droppable(t,{dropped:function(e){m.observer.doAction("commentbox_drop_files",t,e)}})}),t.on("click",".ps-comment-time .activity-post-age",function(e){a(e.currentTarget).children("a").each(function(){var e,t=a(this);t.children(".ps-js-autotime").length&&(e=t.attr("href"),t=location.href.replace(location.hash,""),0===e.indexOf(t)&&(window.location=e,window.location.reload()))})})},10,1)},whenLoaded:function(n){return a.Deferred(function(e){var t=0,o=setInterval(function(){a(".ps-js-comment-container--"+n).length?(clearInterval(o),e.resolve()):60<t++&&(clearInterval(o),e.reject())},1e3)})},add:function(){},edit:function(){},reply:function(e,t,o,n){var i="#comment-item-"+t,o=o?a(o).closest(i):a(i),i=o.find(".actaction-reply"),i=(o=(i.closest(".ps-comments").hasClass("ps-comments--nested")?i.closest(".ps-comments"):i.closest(".ps-comment").next(".ps-comments--nested")).children(".ps-comment-reply")).find("textarea");o.not(":visible")&&o.show(),i.focus(),m.observer.applyFilters("comment.reply",i,a.extend({},n=n||{},{act_id:e,post_id:t})),i.off("keyup.peepso").on("keyup.peepso",function(e){e.stopPropagation(),activity.update_beautifier(e.target)}).trigger("keyup.peepso")},show_previous:function(t,e){var i,s,r,o=".ps-js-comment-container--"+t;return i=e?a(e).closest(o):a(o),s=i.find(".ps-js-comment-more").eq(0),r=s.find(".ps-js-loading"),a.Deferred(function(e){var o,n;o=function(){e.resolve()},n=i.children(".cstream-comment:first"),r.show(),m.postJson("activity.show_previous_comments",{act_id:t,uid:peepsodata.currentuserid,first:n.data("comment-id")},function(e){var t=jQuery("<div />").append(e.data.html),t=m.observer.applyFilters("peepso_activity",t),t=m.observer.applyFilters("peepso_activity_content",t.html());t=(t=t.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"')).replace(/\/\?embed=true([#"])/g,"/?embed=true&peepso=1$1");t=a(t);r.hide(),0==n.length?(n=i.children(".ps-comment-more")).after(t):n.before(t),t.each(function(){1===this.nodeType&&a(this).hasClass("ps-js-comment-item")&&m.hooks.doAction("comment_added",this)}),0<e.data.comments_remain?s.find("a").html(e.data.comments_remain_caption):s.remove(),a(document).trigger("ps_comment_added"),o()})})},show_all:function(t){var s=a(".ps-js-comment-container--"+t),r=s.children(".ps-js-comment-more"),c=r.find(".ps-js-loading"),i=s.children(".cstream-comment:first").data("comment-id");return a.Deferred(function(e){!function o(n){c.show(),m.postJson("activity.show_previous_comments",{act_id:t,uid:peepsodata.currentuserid,all:1,first:i},function(e){var t=jQuery("<div />").append(e.data.html),t=m.observer.applyFilters("peepso_activity",t);t=(t=(t=m.observer.applyFilters("peepso_activity_content",t.html())).replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"')).replace(/\/\?embed=true([#"])/g,"/?embed=true&peepso=1$1");var i=a(t);c.hide(),s.each(function(e){var t=a(this),o=t.children(".cstream-comment:first"),n=i;0<e&&(n=i.clone()),0==o.length?(o=t.children(".ps-comment-more")).after(n):o.before(n)}),i.each(function(){1===this.nodeType&&a(this).hasClass("ps-js-comment-item")&&m.hooks.doAction("comment_added",this)}),0<e.data.comments_remain?(r.find("a").html(e.data.comments_remain_caption),o(n)):(r.remove(),a(document).trigger("ps_comment_added"),n())})}(function(){e.resolve()})})},reveal_comment:function(t,o){return a.Deferred(a.proxy(function(e){a("#comment-item-"+o).length?e.resolve():this.show_all(t).done(a.proxy(function(){e.resolve()},this))},this))},reveal:function(e,t,o,n){function i(e){var t=m.getLinkColor(),o=e.offset().top-(a(window).height()-e.outerHeight())/2;e.css({backgroundColor:t}),e.css({transition:"background-color 3s ease"}),a("html, body").delay(50).animate({scrollTop:o},500,function(){e.css({backgroundColor:""})})}this.reveal_comment(e,t).done(a.proxy(function(){n?this.reveal_comment(o,n).done(function(){i(a("#comment-item-"+n))}):i(a("#comment-item-"+t))},this))}}),new o)}(jQuery,peepso);